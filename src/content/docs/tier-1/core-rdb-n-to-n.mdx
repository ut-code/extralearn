---
title: RDB で N to M のリレーションを記述する
---
import { Tabs, TabItem } from "@astrojs/starlight/components";

[一つ前の章](/tier-1/core-rdb) で扱ったアプリケーションに、「いいね」機能を実装してみましょう。

仕様はこんな感じです。

- ユーザーは、ポストに「いいね」をつけれる。
- ユーザーは、1 人あたり複数のポストにいいねをつけれる。
- ポストは、 1 個あたり複数のユーザーがいいねをつけれる。

SQL のデータベースに直接 n to m のリレーションを記述することはできないため、ひと工夫しましょう。

`liked` (`Liked`) という「中間テーブル」を作成します。

<Tabs syncKey="orm">
  <TabItem label="Prisma">
    ```prisma {15..22}
    model User {
      id    Int    @id @default(autoincrement())
      name  String
      createdPosts Post[]
      likedPosts Post[]
    }

    model Post {
      id        Int    @id @default(autoincrement())
      creatorId Int
      creator   User   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
      content   String
    }

    model Liked {
      likedById Int
      likedBy   User @relation(fields: [likedById], references: [id], onDelete: Cascade)
      postId    Int
      post      Post @relation(fields: [likedById], references: [id], onDelete: Cascade)

      @@unique([likedById, postId])
    }
    ```
  </TabItem>
  <TabItem label="Drizzle">
    <Tabs syncKey="drizzle-kind">
      <TabItem label="Query API">
        ```ts {14..21}
        export const usersTable = sqliteTable("users", {
          id: integer().primaryKey({ autoIncrement: true }),
          name: text().notNull(),
        });
        
        export const postsTable = sqliteTable("posts", {
          id: integer().primaryKey({ autoIncrement: true }),
          creatorId: integer("creator_id")
            .notNull()
            .references(() => usersTable.id, { onDelete: "cascade" }),
          content: text().notNull(),
        });
        
        export const likedTable = sqliteTable("liked", {
          userId: integer("user_id")
            .notNull()
            .references(() => usersTable.id, { onDelete: "cascade" }),
          postId: integer("post_id")
            .notNull()
            .references(() => postsTable.id, { onDelete: "cascade" }),
        });
        
        export const usersRelations = relations(usersTable, ({ many }) => ({
          posts: many(postsTable),
          liked: many(likedTable),
        }));
        
        export const postsRelations = relations(postsTable, ({ one, many }) => ({
          creator: one(usersTable, {
            fields: [postsTable.creatorId],
            references: [usersTable.id],
          }),
          likedBy: many(likedTable),
        }));
        
        export const likedRelaitons = relations(likedTable, ({ one }) => ({
          user: one(usersTable, {
            fields: [likedTable.userId],
            references: [usersTable.id],
          }),
          post: one(postsTable, {
            fields: [likedTable.postId],
            references: [postsTable.id],
          }),
        }));
        ```
      </TabItem>
      <TabItem label="SQL-like">
        ```ts {5}
        const res = await db
          .select()
          .from(usersTable)
          .where(eq(usersTable.id, id))
          .leftJoin(postsTable, eq(postsTable.creatorId, usersTable.id));
        ```
      </TabItem>
    </Tabs>
  </TabItem>
  <TabItem label="SQL">
    ```sql "ON DELETE CASCADE"
    CREATE TABLE users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL
    );

    CREATE TABLE posts (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      creator_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
      content TEXT NOT NULL
    );
    ```
  </TabItem>
</Tabs>

<Tabs syncKey="orm">
  <TabItem label="Prisma">
    ```ts {3..5}
    const user = await prisma.user.findUnique({
      where: { id: 1 },
      include: {
        posts: true,
      },
    });
    ```
  </TabItem>
  <TabItem label="Drizzle">
    <Tabs syncKey="drizzle-kind">
      <TabItem label="Query API">
        ```ts {3..8}
        // schema.ts
        // schema.ts に以下の文を追加します
        export const usersRelations = relations(usersTable, ({ many }) => ({
          posts: many(postsTable),
        }));
        export const postsRelations = relations(postsTable, ({ one }) => ({
          creator: one(usersTable),
        }));
        ```
        ```ts {6..8}
        import * as schema from "./schema.ts";
        const db = drizzle({ schema });

        db.query.usersTable.selectFirst({
          where: eq(usersTable.id, 1),
          with: {
            posts: true,
          }
        })
        ```
      </TabItem>
      <TabItem label="SQL-like">
        ```ts {5}
        const res = await db
          .select()
          .from(usersTable)
          .where(eq(usersTable.id, id))
          .leftJoin(postsTable, eq(postsTable.creatorId, usersTable.id));
        ```
      </TabItem>
    </Tabs>
  </TabItem>
  <TabItem label="SQL">
    ```sql /LEFT JOIN [^;]+/
    SELECT * FROM users WHERE users.id = 1 LEFT JOIN posts ON users.id = posts.creator_id;
    ```
  </TabItem>
</Tabs>

