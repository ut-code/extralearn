---
title: 4. Nix ファイルで Nix Shell を定義し、自動で読み込む
---

# Nix ファイルで Nix Shell を定義する

## 導入

`nix-shell` で、Nix のパッケージを一時的にインストールできることを[2 章で学びました。](../2-ecosystem-nix-shell)

今回は、シェルの定義ファイルを作成して、そこからシェル定義を読み込んでみましょう。

## メリット

ファイルからシェル定義を読み込むと、以下のようなメリットがあります。

- 毎回必要なパッケージを自分で打ち込む必要がない
- プロジェクトで定義ファイルを共有することで、プロジェクトで必要なパッケージをメンバー間で共有できる
- `direnv` などのツールを使い、自動でシェルを読み込むことができる

## シェル定義ファイル

まずは最小の定義を作って動かします。

```nix title="shell.nix"
let
  pkgs = import <nixpkgs> {};
in
  pkgs.mkShell {
    packages = [
      pkgs.hello
      pkgs.cowsay
      pkgs.lolcat
    ];
  }
```

```sh
nix-shell ./shell.nix  # 旧 CLI
# または (Flake)
# nix develop          # flake.nix がある場合

hello --greeting 'Hello, Nix!'
# -> Hello, Nix!

ls | cowsay | lolcat

exit
hello --greeting 'Hello, Nix!'
# -> hello: command not found
```

### ポイント

- `import <nixpkgs> {}` は Nixpkgs のパッケージ集合 (`pkgs`) を読み込みます。
- `pkgs.mkShell { packages = [...] ; }` で必要ツールを含むシェルを作れます。

## Direnv を使って自動で Nix Shell に入る

### セットアップ

:::caution
Home-Manager や NixOS を使う予定の方は、先にそれらのセットアップを終わらせて、それらを使ってインストールすることをおすすめします。

Home-Manager も NixOS も使う予定のない方は、このまま進んでください。
:::

1. Direnv をインストール: https://direnv.net/docs/installation.html
2. Nix-Direnv をセットアップ: https://github.com/nix-community/nix-direnv

### 自動で Nix シェルを読み込む

Direnv は `.envrc` で設定します。

Flake あり:
```txt title=".envrc"
use flake
```

Flake なし:
```txt title=".envrc"
use nix
```

Direnv に `direnv: error .envrc is blocked. Run direnv allow to approve its content` のようなことを言われるので、 `direnv allow` と実行します。

```bash
direnv allow
```

これでディレクトリ入場時に自動で Nix シェルが起動します。

試しに、１個上のディレクトリと行き来してみましょう。

```bash
which hello
# -> /nix/store/9bwryidal9q3g91cjm6xschfn4ikd82q-hello-2.12.1/bin/hello

cd ..
which hello
# -> which: no hello in (paths)

cd nix-shell-sample
which hello
# -> /nix/store/9bwryidal9q3g91cjm6xschfn4ikd82q-hello-2.12.1/bin/hello
```
